# PBC 绩效管理系统

基于 React + NestJS + MySQL 的企业绩效管理系统。

## 技术栈

### 前端
- React 18
- TypeScript
- Ant Design 5
- React Router 6
- Zustand (状态管理)
- Axios

### 后端
- NestJS 10
- **Prisma ORM** (已从 TypeORM 迁移)
- MySQL
- JWT 认证
- Passport

## 项目结构

```
PBCManage/
├── frontend/          # 前端项目
├── backend/           # 后端项目
├── database/          # 数据库脚本
│   ├── migrations/    # 迁移文件
│   └── seeds/         # 种子数据
├── require.md         # 需求文档
├── schema.md          # 数据库设计
└── README.md
```

## 快速开始

### 环境要求
- Node.js >= 18
- MySQL >= 8.0

### 1. 数据库初始化

```bash
# 登录 MySQL，执行建表脚本
mysql -u root -p < database/migrations/001_create_tables.sql

# 执行评价表迁移（新增功能）
mysql -u root -p < database/migrations/003_add_evaluations.sql

# 导入初始数据
mysql -u root -p < database/seeds/001_init_data.sql
```

### 2. 后端启动

```bash
cd backend

# 安装依赖
npm install

# 修改数据库配置 (.env 文件)
# DATABASE_URL="mysql://user:password@host:port/database"

# 生成 Prisma Client
npx prisma generate

# 同步数据库 schema
npx prisma db push

# 开发模式启动
npm run start:dev
```

后端运行在 http://localhost:3001

**注意**：⚠️ **Service 文件还需要从 TypeORM 迁移到 Prisma**，详见 `backend/PRISMA_STATUS.md`

### 3. 前端启动

```bash
cd frontend

# 安装依赖
npm install

# 开发模式启动
npm start
```

前端运行在 http://localhost:3000

## 测试账号

| 账号 | 密码 | 角色 | 说明 |
|------|------|------|------|
| zijie | 123456 | 总经理 | 可查看所有员工PBC |
| heyue | 123456 | 技术总监 | 可审核技术部员工PBC |
| juzi | 123456 | 市场总监 | 可审核市场部员工PBC |
| haibin | 123456 | 员工 | 普通员工 |

## 主要功能

### MVP阶段（当前）
- [x] 用户登录/登出
- [x] 修改密码
- [x] PBC目标填写
- [x] 提交审核
- [x] 主管审核（通过/驳回）
- [x] 人员管理（增删改）
- [x] Excel批量导入人员
- [x] 部门管理（CRUD）
- [x] 员工自评功能
  - 对已通过审核的目标进行自评（分数+评价）
  - 所有目标自评完成后提交整体自评（至少100字）
- [x] 主管评价功能
  - 查看员工自评结果
  - 对每个目标进行评分和评价
  - 提交整体主管评价（至少100字）
- [x] 员工查看反馈
  - 查看主管对各目标的评分和评价
  - 查看整体主管评价

### 第二阶段
- [ ] 历史记录筛选
- [ ] 权限细化
- [ ] 数据统计报表

### 第三阶段
- [ ] 导出功能
- [ ] 系统设置

## API 文档

### 认证接口
- `POST /api/auth/login` - 登录
- `POST /api/auth/logout` - 登出
- `POST /api/auth/change-password` - 修改密码

### 用户接口
- `GET /api/users` - 用户列表
- `POST /api/users` - 创建用户
- `POST /api/users/import` - Excel导入
- `PUT /api/users/:id` - 更新用户
- `DELETE /api/users/:id` - 删除用户

### PBC接口
- `GET /api/pbc` - PBC列表
- `POST /api/pbc` - 创建PBC（总经理创建的目标自动通过审核）
- `PUT /api/pbc/:id` - 更新PBC
- `DELETE /api/pbc/:id` - 删除PBC
- `POST /api/pbc/submit` - 批量提交审核（提交当前周期所有草稿状态目标）
- `GET /api/pbc/team-goals` - 获取团队目标（根据权限）
- `GET /api/pbc/supervisor-goals` - 获取上级目标（用于关联）

### 自评与评价接口
- `POST /api/pbc/:id/self-evaluate` - 对单个目标进行自评
- `POST /api/pbc/submit-self-evaluation` - 提交整体自评
- `GET /api/pbc/evaluation/:userId/:periodId` - 获取评价信息
- `POST /api/pbc/:id/supervisor-evaluate` - 主管评价单个目标
- `POST /api/pbc/submit-supervisor-evaluation` - 提交整体主管评价

### 审核接口
- `GET /api/reviews/pending` - 待审核列表
- `POST /api/reviews/:id/approve` - 通过审核
- `POST /api/reviews/:id/reject` - 驳回审核
- `POST /api/reviews/:id/archive` - 归档

### 部门接口
- `GET /api/departments` - 部门列表（根据权限）
- `POST /api/departments` - 创建部门（仅GM）
- `PUT /api/departments/:id` - 更新部门（仅GM）
- `DELETE /api/departments/:id` - 删除部门（仅GM）

## 业务规则

### PBC 目标创建规则
1. **目标类型权限**：
   - 普通员工：只能创建"业务目标"和"个人能力提升"（界面不显示"组织与人员管理&团队建设"选项）
   - 经理/助理/总经理：可以创建所有类型的目标（包括"组织与人员管理&团队建设"）
2. **上级目标关联**：
   - **业务目标**：
     - 总经理：不显示上级目标字段
     - 其他角色：**可选择性关联**上级主管的一条业务目标（不强制要求），关联有助于目标对齐
   - **个人能力提升**：不需要关联上级目标
   - **组织与人员管理&团队建设**：不需要关联上级目标
3. **评价标准**：
   - **业务目标**：必须填写"不可接受"、"达标"、"卓越"三个评价标准
   - **个人能力提升**：不需要填写评价标准
   - **组织与人员管理&团队建设**：不需要填写评价标准
4. **总经理免审**：总经理创建的目标无需审批，创建后自动设置为"已通过"状态

### PBC 提交规则
1. **批量提交**：员工可以创建多个业务目标，提交时会自动批量提交当前周期的所有草稿或被驳回的目标，不支持单条提交
2. **目标修改**：只有草稿和被驳回的目标可以修改和删除

### PBC 审批规则
1. **批量提交**：员工在界面顶部点击统一的"提交审批"按钮，自动批量提交当前周期所有目标
2. **批量审批**：主管审批时，一次性对员工当前周期的所有目标做出决定：
   - 通过：当前周期所有已提交的目标全部通过
   - 驳回：当前周期所有已提交的目标全部驳回
3. **状态统一**：因为是批量审批，同一周期内的所有目标状态应保持一致

### 菜单权限规则
1. **普通员工（employee）**：
   - 仅拥有"我的PBC"菜单
   - 可以创建、编辑、提交自己的PBC目标
   - 可以进行自评和查看主管反馈
   - 可以修改密码

2. **经理（manager）**：
   - 我的PBC：管理自己的PBC目标
   - 团队目标：查看本部门所有员工的目标
   - 审核管理：审核本部门员工提交的目标
   - 人员管理：管理本部门的人员
   - 可以修改密码

3. **助理（assistant）和总经理（gm）**：
   - 拥有所有菜单权限
   - 我的PBC、团队目标、审核管理、人员管理、部门管理
   - 可以修改密码

4. **路由保护**：
   - 用户只能访问其权限范围内的页面
   - 如果通过URL直接访问无权限页面，会被重定向到"我的PBC"页面

### 人员管理权限
1. **普通员工**：只能查看自己的信息，不能编辑、创建或删除任何用户
2. **经理**：可以查看和管理本部门的人员
3. **助理/总经理**：可以查看和管理所属部门及所有子部门的人员

### 团队目标查看权限
1. **功能说明**：按员工和周期分组展示所有非草稿状态的目标（包括业务目标、个人能力提升、组织与人员管理&团队建设）
2. **普通员工**：只能查看自己在各个季度的所有目标
3. **经理**：可以查看本部门所有员工在各个季度的所有目标
4. **助理/总经理**：可以查看所属部门及所有子部门的所有员工在各个季度的所有目标
5. **筛选功能**：支持按员工姓名和周期筛选
6. **展示方式**：分组显示，可展开查看该员工该周期的目标明细
7. **功能入口**：在系统菜单中"团队目标"菜单项

### 审核管理规则
1. **按员工分组显示**：审核页面按员工和周期分组展示待审核目标
2. **批量审批**：每个员工组提供"批量通过"和"批量驳回"按钮
3. **权重验证**：批量通过时自动验证权重总和是否为100%
4. **可展开查看**：点击展开按钮可查看该员工的所有目标详情

### 批量提交规则
1. **权重计算逻辑**：
   - 提交时会验证该周期内**所有主目标**的权重总和（包括draft、rejected、approved状态）
   - 这确保了变更已通过的目标后，仍能正确验证总权重
   - 例如：原有3个目标都是approved（20%+60%+20%=100%），变更其中1个后变为draft，提交时仍会计算所有3个目标的总权重
2. **数据类型处理**：
   - 前端会自动将goal_weight、period_id等数字字段转换为number类型
   - 避免后端DTO验证错误

### 自评与主管评价规则
1. **自评流程**：
   - 只有状态为"已通过"的目标可以进行自评
   - 在"我的PBC"页面，点击目标行的"自评"按钮进行单个目标自评
   - 每个目标需要填写：自评分数（0-100）+ 自评说明
   - 所有目标完成自评后，点击"提交整体自评"按钮
   - 整体自评需要填写本季度整体工作总结（至少100字）
   - **提交整体自评后，不允许修改单个目标的自评内容**
   
2. **主管评价流程**：
   - 在"团队目标"页面，可以看到已提交自评的员工
   - 点击"查看自评"查看员工的自评详情
   - 在评价详情页面，对每个目标进行评分和评价
   - 评价包括：主管评分（0-100）+ 主管评价意见
   - 所有目标完成评价后，点击"提交整体评价"按钮
   - 整体评价需要填写对员工本季度表现的总结（至少100字）
   
3. **查看反馈**：
   - 员工可以在"我的PBC"页面查看自己的自评和主管反馈
   - 包括每个目标的自评分数、主管评分、双方评价
   - 包括整体自评和整体主管评价
   
4. **评价权限**：
   - 员工只能对自己已通过的目标进行自评
   - 主管只能评价自己直接下属的目标
   - 员工提交整体自评后，主管才能开始评价
   - 主管完成所有目标评价后，才能提交整体评价

### 目标修改规则
1. **草稿和被驳回状态**：
   - 可以随意编辑和删除
   - 按钮显示："编辑"、"删除"
   - 修改后不影响状态
   
2. **已通过状态（未提交自评）**：
   - **允许变更和新增目标**
   - 按钮显示："变更"、"自评"
   - 变更后，目标状态自动重置为"草稿"
   - 已有的自评和主管评价将被清空
   - **提交按钮会自动显示**，允许重新提交审核
   - 系统会在变更时显示警告提示
   - 状态判断优先级：只要存在draft/rejected状态的目标，整体状态就是draft/rejected，允许提交
   
3. **已通过状态（已提交自评）**：
   - **不允许变更**（已进入评估阶段）
   - 按钮显示："查看"、"查看自评"
   - 只能查看目标和自评内容
   - 后端会拦截变更请求，提示："已提交自评，不允许变更目标"
   
4. **已提交状态（审批中）**：
   - **不允许编辑和删除**（审批流程进行中）
   - 按钮显示："查看"
   - 只能查看目标内容
   - 后端会拦截修改请求，提示："目标审批中，不允许修改。如需修改，请联系主管撤回审批。"
   - 如需修改，需等待审批结果（通过或驳回）
   
5. **已归档状态**：
   - 不允许编辑和变更
   - 按钮显示："查看"
   - 只能查看目标内容
   - 后端会拦截修改请求，提示："目标已归档，不允许修改"

## 开发说明

### 后端模块结构
- `auth` - 认证模块（登录、JWT）
- `users` - 用户模块
- `departments` - 部门模块
- `pbc` - PBC目标模块
- `reviews` - 审核模块

### 前端页面结构
- `Login` - 登录页
- `PBC` - PBC填写/列表页
- `Review` - 审核管理页
- `UserManage` - 人员管理页
- `ChangePassword` - 修改密码页

## 许可证

MIT
