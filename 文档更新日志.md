# 需求文档更新日志

## 更新时间
2026年1月27日

## 更新原因
系统检查发现代码实现与需求文档存在不一致，进行同步更新。

## 主要更新内容

### 1. require.md 更新

#### 1.1 修正上级目标关联规则（第148-156行）
**问题**：文档中存在矛盾
- 第19行说"可以选择性关联"(可选)
- 第148-152行说"必须查看...必须选择关联"(必填)

**修复**：
- ✅ 统一为"可选"关联
- ✅ 明确说明：关联上级目标有助于目标对齐，但不强制
- ✅ 说明如果上级还没有创建目标，不会阻塞下级创建

**修改前**：
```markdown
- **业务目标关联规则**：除总经理外，所有人在创建业务目标时：
  - 必须查看上级主管的业务目标
  - 创建目标时必须选择关联其中一条上级的业务目标
```

**修改后**：
```markdown
- **业务目标关联规则**：除总经理外，所有人在创建业务目标时：
  - **可以选择性关联**上级主管的业务目标（不强制要求）
  - 系统会展示上级主管的业务目标供选择
  - 关联上级目标有助于目标对齐和层级追踪，但不强制
  - 如果上级还没有创建目标，或目标未审核通过，也不会阻塞下级创建目标
```

#### 1.2 新增部门管理模块说明（第144-171行）
**问题**：代码中有完整的部门管理功能，但文档中只简单提到，没有详细说明

**新增内容**：
- ✅ 部门管理功能说明（CRUD操作）
- ✅ 部门层级结构说明
- ✅ 详细的权限控制说明：
  - GM和Assistant：完整管理权限
  - Manager：只能查看本部门
  - Employee：无权访问

#### 1.3 新增周期管理模块说明（第144-157行）
**问题**：文档中多处提到"周期"但没有专门章节介绍

**新增内容**：
- ✅ 周期管理功能说明
- ✅ 周期状态说明（active/closed）
- ✅ 自动关联机制
- ✅ 唯一约束说明
- ✅ 使用场景

### 2. schema.md 完全重写

#### 2.1 修正用户表字段
**问题**：字段名称和约束与实际代码不一致

**修改**：
- ✅ `password` → `password_hash`（更准确）
- ✅ 添加 `department_id` 和 `supervisor_id` 的"可空"约束
- ✅ 明确 `role` 枚举值（employee/assistant/manager/gm）

#### 2.2 新增考核周期表（pbc_periods）
**问题**：实际代码中有此表，但文档中没有

**新增**：
- ✅ 完整的周期表结构
- ✅ 字段说明（year, quarter, start_date, end_date, status）
- ✅ 唯一约束说明

#### 2.3 更新绩效目标表（pbc_goals）
**问题**：缺少多个重要字段

**新增字段**：
- ✅ `period_id`：关联考核周期
- ✅ `measures`：实施举措
- ✅ `completion_time`：预计完成时间
- ✅ `status`：目标状态枚举（draft/submitted/approved/rejected/archived）
- ✅ `self_score`：自评分数
- ✅ `self_comment`：自评说明
- ✅ `supervisor_score`：主管评分
- ✅ `supervisor_comment`：主管评价

**修改说明**：
- ✅ 更新 `supervisor_goal_id` 描述为"可选"
- ✅ 添加状态说明
- ✅ 添加索引说明
- ✅ 修正评价标准字段为"可空"（仅业务目标需要）

#### 2.4 删除过时的表
**删除**：
- ❌ `performance_reviews` 表（功能已合并到 pbc_goals）
- ❌ `skills_improvement` 表（功能已合并到 pbc_goals）

#### 2.5 新增审批记录表（pbc_approvals）
**问题**：实际代码中有此表，但文档中没有

**新增**：
- ✅ 完整的审批记录表结构
- ✅ 记录审批历史（submit/approve/reject）
- ✅ 驳回意见字段

#### 2.6 新增整体评价表（pbc_evaluations）
**问题**：实际代码中有此表，但文档中没有

**新增**：
- ✅ 员工整体自评字段
- ✅ 主管整体评价字段
- ✅ 提交时间字段
- ✅ 唯一约束说明（user_id + period_id）

#### 2.7 新增表关系说明
**新增章节**：
- ✅ 用户与部门关系
- ✅ 用户层级关系
- ✅ 目标与用户关系
- ✅ 目标与周期关系
- ✅ 目标层级关系
- ✅ 审批记录关系
- ✅ 整体评价关系

#### 2.8 完善设计注意事项
**新增**：
- ✅ 级联删除策略说明
- ✅ 索引优化建议
- ✅ 数据一致性保证机制

### 3. README.md（无需修改）

经检查，README.md 已经是最新的，包含了：
- ✅ 正确的数据库迁移文件列表
- ✅ 完整的功能列表
- ✅ 详细的业务规则
- ✅ API 文档
- ✅ 菜单权限规则
- ✅ 目标修改规则

## 文档一致性对比

### 修改前后对比

| 项目 | 修改前 | 修改后 | 状态 |
|-----|--------|--------|------|
| 上级目标关联 | 文档有矛盾（一处说可选，一处说必填）| 统一为可选 | ✅ 已修复 |
| 部门管理功能 | 只简单提到 | 详细说明（功能+权限）| ✅ 已补充 |
| 周期管理功能 | 未专门说明 | 新增完整章节 | ✅ 已补充 |
| pbc_goals表 | 缺少8个字段 | 补充完整字段 | ✅ 已修复 |
| pbc_periods表 | 未记录 | 新增完整表结构 | ✅ 已补充 |
| pbc_approvals表 | 未记录 | 新增完整表结构 | ✅ 已补充 |
| pbc_evaluations表 | 未记录 | 新增完整表结构 | ✅ 已补充 |
| 过时的表 | performance_reviews, skills_improvement | 已删除 | ✅ 已清理 |
| 表关系说明 | 未记录 | 新增详细说明 | ✅ 已补充 |

## 验证结果

- ✅ 前端编译：成功
- ✅ 文档逻辑：一致
- ✅ 代码实现：匹配

## 结论

所有需求文档已与代码实现完全同步，文档间不再存在矛盾和遗漏。

## 文件清单

更新的文件：
1. `require.md` - 需求文档
2. `schema.md` - 数据库设计文档（完全重写）

未更新的文件：
- `README.md` - 已是最新状态
- 代码文件 - 无需修改

---

**更新人员**：AI Assistant  
**审核状态**：待人工审核  
**下次更新**：代码逻辑重大变更时
