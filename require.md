# 绩效管理系统需求文档

## 1. 系统概述
本系统旨在帮助企业管理员工绩效，通过每季度的PBC（个人业务承诺）提报、审核、归档及自评和主管评估，确保员工的目标明确、绩效可追踪。

## 2. 主要功能模块

### 2.1 员工PBC填写模块
员工每季度根据公司目标和个人发展需求填写PBC，内容包括业务目标和个人能力提升。填写时需要遵循以下要求：

#### 目标类型说明
- **业务目标**：每个角色对应的业务目标，下级创建业务目标时需要关联上级的业务目标，并设定评价标准
- **个人能力提升**：员工个人能力发展目标，不需要关联上级目标，不需要填写评价标准
- **组织与人员管理&团队建设**：助理、经理、总经理可以创建此类目标；普通员工在创建目标时不显示此选项

#### 目标排序规则
在所有目标列表展示的地方（我的PBC、审核管理、团队目标查看、查看反馈等），系统会自动对目标进行排序：
1. **首先按目标类型优先级排序**：
   - 业务目标（优先级1，排在最前）
   - 组织与人员管理&团队建设（优先级2，排在中间）
   - 个人能力提升（优先级3，排在最后）
2. **同类型内按权重倒序排列**：权重值大的排在前面
3. **排序实现**：前端使用统一的`sortGoals`工具函数，确保所有页面排序逻辑一致
4. **排序目的**：
   - 让评审者优先关注最重要的业务目标
   - 同类型目标中，优先看到权重高的关键目标
   - 提升评审效率，优化用户体验

#### 业务目标填写要求
- **主目标描述**：员工填写本季度的主要业务目标，确保目标明确、具体。
- **目标权重**：员工为每个目标分配权重，所有目标的总权重为100%。
- **关联上级目标**：业务目标**可以选择性关联**上级主管的业务目标（总经理无此字段）。关联上级目标有助于目标对齐，但不强制要求。
- **实现举措**：描述实现目标的具体行动和措施，确保可操作性（业务目标和组织与人员管理&团队建设必填）。
- **子目标描述**：每个主目标下的具体子目标，员工需要具体描述子目标。
- **子目标实现举措**：员工填写实现子目标的具体行动和措施，确保可操作性。
- **评价标准**：仅业务目标需要设定评价标准，分别描述"不可接受"、"达标"和"卓越"。

#### 个人能力提升填写要求
- **待提升或发展能力**：员工填写自己需要提升或发展的具体能力。
- **权重**：为每项能力提升分配权重，总和为100%。
- **措施和衡量标准**：描述提升该能力的具体措施以及衡量标准，如何评估能力是否提升。
- **完成时间**：每项能力提升的预计完成时间。
- **无需关联上级目标**：个人能力提升目标不需要关联上级的团队目标
- **无需评价标准**：个人能力提升目标不需要填写"不可接受"、"达标"、"卓越"标准

### 2.2 主管审核模块
主管对员工提报的PBC进行审核，判断其目标是否符合公司要求，并提供反馈。

#### 提交规则
- **批量提交**：员工可以同时创建多个业务目标，也可以单独创建，但提交审批时必须一起提交当前周期的所有目标（包括草稿和被驳回的目标），不可以单条记录提交。
- **统一提交按钮**：界面上提供统一的"提交审批"按钮，点击后自动批量提交当前周期内所有待提交的目标给主管审核。
- **总经理特殊规则**：总经理创建的目标无需审批，创建后直接设置为"已通过"状态，不需要提交审核流程。
- **权重验证逻辑**：
  - 提交时系统会验证该周期内**所有主目标**的权重总和（包括draft、rejected、approved状态）
  - 必须等于100%才能提交成功
  - **场景示例**：如果用户有3个目标都已通过（20%+60%+20%），变更其中1个后（该目标变为draft），提交时仍会计算所有3个目标的总权重
  - 这确保了变更已通过的目标后，权重验证依然准确
- **数据类型处理**：前端会自动将数字字段（goal_weight、period_id等）转换为number类型，避免后端验证错误

#### 审批规则
- **按员工批量审批**：审核页面按员工分组显示，主管对每个员工的目标进行批量审批：
  - 每个员工的所有目标显示在一个组内，展示目标数量和权重总和
  - 点击"批量通过"或"批量驳回"按钮，一次性处理该员工当前周期的所有目标
  - 通过审核时会验证权重总和是否为100%
  - 不存在部分通过、部分驳回的情况
- **驳回重提**：如果目标被驳回，员工修改后再次提交时，仍然是批量提交所有目标

#### 审核内容
- **员工目标描述与任务**：主管可以查看员工填写的业务目标和能力提升目标。
- **审核结果**：主管对员工的目标进行审核，标注"通过"或"不通过"。
- **驳回原因**：如果目标不符合要求，主管需要填写驳回原因，并提示员工修改。驳回后的目标可以重新编辑并再次批量提交。

### 2.3 PBC归档模块
主管审核通过后，员工的PBC将被归档，员工可以随时查看自己的历史绩效记录。

### 2.4 自评与主管评估模块
员工在季度末根据自己的实际表现进行自评，主管根据员工的实际表现进行评估。

#### 自评
- **自评流程**：
  - 只有状态为"已通过"的目标可以进行自评
  - 员工对每个目标填写：自评分数（0-100）+ 自评说明
  - 所有目标完成自评后，提交整体自评（至少100字）
  - **重要限制**：提交整体自评后，不允许修改单个目标的自评内容
  - 提交整体自评后，员工只能查看自评内容，不能修改

#### 主管评估
- **评估流程**：
  - 主管在"团队目标"页面查看员工的自评
  - 对每个目标进行评分和评价：主管评分（0-100）+ 主管评价意见
  - 所有目标评价完成后，提交整体评价（至少100字）
  - 主管提交整体评价后，员工可以查看反馈结果

#### 目标变更规则
- **已通过目标的变更（未提交自评）**：
  - 当前季度的PBC如果提交审核并通过后，**允许变更和新增**
  - 按钮显示为"变更"（而非"编辑"），明确区分意义
  - 变更已通过的目标时，系统会显示警告提示：变更后状态将重置为草稿，需要重新提交审核
  - 变更后，已有的自评和主管评价将被清空
  - 变更后的目标需要重新走审批流程
  - **智能状态管理**：当有任何目标变更为草稿状态时，"提交审批"按钮会自动显示，允许重新提交
  - 状态优先级：draft/rejected（可提交） > submitted（审核中） > approved（已通过） > archived（已归档）
  
- **自评后的限制**：
  - 提交整体自评后，**不允许变更目标内容**（已进入评估阶段）
  - 提交整体自评后，不允许修改单个目标的自评内容
  - 按钮显示为"查看"和"查看自评"，无法进行编辑操作
  - 后端会拦截变更请求，提示"已提交自评，不允许变更目标"
  
- **不同状态的操作权限**：
  - **草稿/被驳回**：显示"编辑"和"删除"按钮，可以自由修改和删除
  - **已提交（审批中）**：显示"查看"按钮，**不允许修改和删除**，只能查看。如需修改需等待审批结果或联系主管撤回
  - **已通过（未自评）**：显示"变更"和"自评"按钮，允许变更目标（变更后重置为草稿）
  - **已通过（已自评）**：显示"查看"和"查看自评"按钮，**不允许变更**（已进入评估阶段）
  - **已归档**：显示"查看"按钮，**不允许修改**，只能查看历史记录
  
- **后端保护机制**：
  - 对于submitted（审批中）状态，后端会拦截修改请求，返回："目标审批中，不允许修改。如需修改，请联系主管撤回审批。"
  - 对于已提交自评的approved状态，后端会拦截修改请求，返回："已提交自评，不允许变更目标。如需变更，请联系主管。"
  - 对于archived（已归档）状态，后端会拦截修改请求，返回："目标已归档，不允许修改"
  - 删除操作只允许draft状态的目标

### 2.5 人员管理模块
系统支持人员信息导入、层级管理和权限设置。

#### 人员导入
- **导入方式**：支持通过Excel导入人员信息，字段包括姓名、工号、部门、职级、岗位、直属主管。
- **岗位分类**：岗位包括员工、助理、经理、总经理等，助理可以拥有对应部门的主管权限。

#### 层级管理
- **层级结构**：支持层级展示，管理员可以调整层级关系，手动设置员工的直属主管。
- **权限管理**：系统根据员工的层级和角色分配不同的权限：
  - **普通员工**：只能查看自己的信息，不能编辑、创建或删除任何用户
  - **经理**：可以查看和管理本部门的人员
  - **助理/总经理**：可以查看和管理所属部门及所有子部门的人员

### 2.6 历史记录查看模块
主管可以根据权限查看对应年份和季度的历史记录，包括员工的PBC填写、审核、评估等信息。

#### 查看权限
- **层级权限**：主管只能查看自己团队成员的历史记录，不能访问其他部门或层级的记录。
- **筛选条件**：根据年份和季度筛选查看历史记录，方便主管了解员工的历次绩效。

### 2.7 团队目标查看模块
按照人员和季度分组，展示团队成员在各个季度的目标完成情况。展示除草稿外所有状态的目标（已提交、已通过、已驳回、已归档）。

#### 功能说明
- **数据展示**：按员工+周期分组显示，每个分组显示该员工在该季度的所有目标（包括业务目标、个人能力提升、组织与人员管理&团队建设）
- **详细信息**：点击展开可查看该员工该季度的所有目标明细，包括目标名称、类型、权重、状态、描述和评价标准
- **状态筛选**：仅展示非草稿状态的目标（已提交、已通过、已驳回、已归档）

#### 查看权限
- **普通员工**：只能查看自己在各个季度的所有目标
- **经理**：可以查看本部门所有员工在各个季度的所有目标
- **助理/总经理**：可以查看所属部门及所有子部门的所有员工在各个季度的所有目标
- **筛选条件**：支持按员工姓名、周期、部门筛选

### 2.8 周期管理模块
系统支持按季度管理PBC考核周期。

#### 功能说明
- **周期结构**：以年度和季度为单位（如2026年第1季度）
- **周期状态**：
  - `active`：活跃周期，可以创建和提交目标
  - `closed`：已关闭，不可创建新目标
- **自动关联**：创建目标时，系统会关联当前活跃的周期
- **唯一约束**：同一年度和季度的组合唯一，不可重复创建

#### 使用场景
- 员工创建目标时，系统自动关联到当前活跃周期
- 查看历史记录时，可以按周期筛选
- 管理员可以创建新周期或关闭旧周期

### 2.9 部门管理模块
系统支持部门的层级管理，包括部门的新增、编辑、删除和查看。

#### 功能说明
- **部门层级**：部门支持树形层级结构，可以设置上级部门（parent_id）
- **CRUD操作**：
  - **创建部门**：输入部门名称和选择上级部门（可选），创建新部门
  - **编辑部门**：修改部门名称或上级部门
  - **删除部门**：删除部门及其所有子部门（级联删除）
  - **查看部门**：展示部门列表，显示部门名称、上级部门、创建时间等信息

#### 权限控制
- **总经理（gm）和助理（assistant）**：
  - 拥有完整的部门管理权限
  - 可以创建、编辑、删除任何部门
  - 可以查看所有部门
- **经理（manager）**：
  - 只能查看本部门及子部门
  - 不能进行创建、编辑、删除操作
- **普通员工（employee）**：
  - 无法访问部门管理功能

## 3. 系统功能需求

### 3.1 层级关系管理
- **总经理创建目标**：总经理创建目标时不显示上级业务目标字段，因为他是最高层级。
- **业务目标关联规则**：除总经理外，所有人（包括经理、助理、员工）在创建**业务目标**时：
  - **可以选择性关联**上级主管的业务目标（不强制要求）
  - 系统会展示上级主管的业务目标（已审核通过的，当前季度的）供选择
  - 关联上级目标有助于目标对齐和层级追踪，但不强制
  - 如果上级还没有创建目标，或目标未审核通过，也不会阻塞下级创建目标
- **其他类型目标无需关联**：
  - **个人能力提升**目标：不需要关联上级目标
  - **组织与人员管理&团队建设**：不需要关联上级目标

### 3.2 评价标准
- **仅业务目标需要**：只有**业务目标**需要设定"不可接受"、"达标"和"卓越"三个评价标准，确保绩效评估时有明确的判定依据。
- **其他目标类型无需评价标准**：个人能力提升和组织与人员管理&团队建设不需要填写评价标准。

### 3.3 登录模块
- **账号字段**：在人员信息导入时，除了姓名、工号、部门等信息，还需要新增"账号"字段。该字段用于员工登录时使用。
- **默认密码**：每个员工账号的初始密码默认为`123456`，员工登录后可以自行修改密码。
- **登录功能**：员工和主管都可以使用自己对应的账号和密码登录系统，系统会验证账号密码的正确性。
- **密码安全性**：虽然初始密码设置为`123456`，但后续可以根据需求更改为更复杂的密码策略。

### 3.4 系统菜单权限
系统根据用户角色分配不同的菜单权限，确保用户只能访问其权限范围内的功能。

#### 普通员工（employee）
- **可见菜单**：仅"我的PBC"菜单
- **功能权限**：
  - 创建、编辑、提交自己的PBC目标
  - 进行自评和查看主管反馈
  - 修改密码
- **限制**：无法访问团队目标、审核管理、人员管理、部门管理等其他功能

#### 经理（manager）
- **可见菜单**：我的PBC、团队目标、审核管理、人员管理
- **功能权限**：
  - 管理自己的PBC目标
  - 查看本部门所有员工的目标
  - 审核本部门员工提交的目标
  - 管理本部门的人员信息
  - 修改密码
- **限制**：无法访问部门管理功能

#### 助理（assistant）和总经理（gm）
- **可见菜单**：所有菜单（我的PBC、团队目标、审核管理、人员管理、部门管理）
- **功能权限**：
  - 拥有系统的所有功能权限
  - 可以管理所属部门及所有子部门的数据
  - 总经理和助理可以进行部门的增删改操作
  - 修改密码

#### 路由保护
- **前端保护**：菜单根据角色动态显示，用户只能看到其权限范围内的菜单项
- **后端保护**：即使用户通过URL直接访问，系统也会验证权限并重定向到授权页面
- **默认重定向**：无权限访问时，自动重定向到"我的PBC"页面

### 3.6 钉钉通知集成 🆕

系统集成钉钉工作通知功能，在PBC审批流程的关键节点自动发送消息提醒。

#### 通知触发场景

**1. 提交审批通知（给主管）**
- **触发时机**：员工点击"提交审批"按钮提交PBC目标时
- **通知对象**：员工的直属主管
- **通知内容**：`{员工姓名} 提交了 {年份}年第{季度}季度 的PBC目标（共{数量}个），请及时审核。`

**2. 审核通过通知（给员工）**
- **触发时机**：主管点击"批量通过"审核员工PBC目标时
- **通知对象**：目标所属员工
- **通知内容**：`您的 {年份}年第{季度}季度 PBC目标（共{数量}个）已通过审核。`

**3. 审核驳回通知（给员工）**
- **触发时机**：主管点击"批量驳回"驳回员工PBC目标时
- **通知对象**：目标所属员工
- **通知内容**：`您的 {年份}年第{季度}季度 PBC目标（共{数量}个）未通过审核。驳回原因：{驳回理由}。请修改后重新提交。`

#### 钉钉userid配置

- **字段名称**：`dingtalk_userid`
- **字段位置**：`users`表
- **字段类型**：`VARCHAR(255)`，可空
- **配置方式**：
  1. 登录系统进入"人员管理"
  2. 编辑用户信息，在"钉钉用户ID"字段填写对应的钉钉userid
  3. 如果用户未配置userid，系统会跳过通知，不影响业务流程

#### 技术说明

- **消息类型**：工作通知（text类型）
- **通知方式**：异步发送，不阻塞主流程
- **失败处理**：通知发送失败仅记录日志，不影响审批流程
- **Token管理**：自动获取和缓存Access Token，有效期7200秒
- **API文档**：https://open.dingtalk.com/document/orgapp/asynchronous-sending-of-enterprise-session-messages

详细配置和使用文档参见：[DINGTALK_INTEGRATION.md](../DINGTALK_INTEGRATION.md)

---

如果需要进一步调整或补充任何部分，随时告诉我！
